<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe QR Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --error: #dc2626; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; }
        .scanner-card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px; text-align: center; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; min-height: 250px; }
        #status-msg { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: 600; display: none; font-size: 0.9rem; }
        .status-success { background-color: #dcfce7; color: var(--success); }
        .status-error { background-color: #fee2e2; color: var(--error); }
        .status-warn { background-color: #fef9c3; color: var(--warning); }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        button { flex: 1; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; }
        .btn-primary { background-color: var(--primary); }
        .btn-download { background-color: var(--success); }
        .table-container { background: var(--card); border-radius: 12px; width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <div class="scanner-card">
        <div id="reader"></div>
        <div id="status-msg"></div>
    </div>

    <div class="controls">
        <button id="start-btn" class="btn-primary" onclick="startScanner()">Start Camera</button>
        <button id="stop-btn" class="btn-primary" onclick="stopScanner()" style="display:none; background: #64748b;">Stop</button>
        <button class="btn-download" onclick="exportToCSV()">Export CSV</button>
    </div>

    <div class="table-container">
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>Total</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    let html5Qr;
    let scannedData = [];

    function startScanner() {
        const statusEl = document.getElementById("status-msg");
        document.getElementById("start-btn").style.display = 'none';
        document.getElementById("stop-btn").style.display = 'inline-block';
        
        showStatus("Requesting Camera Permission...", "warn");

        // Use the simplest possible initialization
        html5Qr = new Html5Qrcode("reader");

        // NO high-res constraints - let the browser decide
        const config = { fps: 10, qrbox: 250 };

        html5Qr.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess, 
            onScanFailure
        ).catch(err => {
            showStatus("Error: " + err, "error");
            document.getElementById("start-btn").style.display = 'inline-block';
            document.getElementById("stop-btn").style.display = 'none';
        });
    }

    async function stopScanner() {
        if (html5Qr) {
            await html5Qr.stop();
            html5Qr.clear();
        }
        document.getElementById("start-btn").style.display = 'inline-block';
        document.getElementById("stop-btn").style.display = 'none';
        showStatus("Camera stopped.", "warn");
    }

    function onScanSuccess(decodedText) {
        try {
            const data = JSON.parse(decodedText);
            if(scannedData.some(item => item.id === data.id)) {
                showStatus("Duplicate: " + data.id, "warn");
                return;
            }
            
            const record = {
                id: data.id,
                name: data.name,
                total: (parseFloat(data.sub || 0) + parseFloat(data.ship || 0)).toFixed(2)
            };

            scannedData.push(record);
            renderTable();
            showStatus("Scanned: " + data.id, "success");
            
            html5Qr.pause();
            setTimeout(() => html5Qr.resume(), 2000);
        } catch (e) {
            console.log("Not a valid JSON QR");
        }
    }

    function onScanFailure() {}

    function showStatus(msg, type) {
        const el = document.getElementById("status-msg");
        el.style.display = "block";
        el.className = "status-" + type;
        el.innerText = msg;
    }

    function renderTable() {
        const body = document.getElementById("table-body");
        body.innerHTML = scannedData.map(row => 
            `<tr><td>${row.id}</td><td>${row.name}</td><td>${row.total}</td></tr>`
        ).join('');
    }

    function exportToCSV() {
        if (scannedData.length === 0) return alert("No data");
        let csv = "ID,Name,Total\n" + scannedData.map(r => `${r.id},${r.name},${r.total}`).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scans.csv';
        a.click();
    }
</script>
</body>
</html>
